version: 1

frontend:
  env:
    variables:
      NODE_ENV: production
      # API_URL: Set this in Amplify Console > App settings > Environment variables
      # Example: https://your-app.us-east-1.elasticbeanstalk.com
      # Leave empty or unset if frontend and backend are on same domain
  phases:
    preBuild:
      commands:
        - echo "PreBuild phase - checking for submodules"
        - |
          if [ -f .gitmodules ]; then
            echo "Found .gitmodules, updating submodules..."
            git submodule update --init --recursive || echo "Submodule update failed, continuing..."
          else
            echo "No .gitmodules found, skipping submodule update"
          fi
    build:
      commands:
        - npm install
        - |
          # Inject API_URL into HTML files if environment variable is set
          if [ -n "$API_URL" ]; then
            echo "Injecting API_URL into HTML files: $API_URL"
            find public -name "*.html" -type f -exec sed -i.bak "s|<meta name=\"api-url\" content=\"\">|<meta name=\"api-url\" content=\"$API_URL\">|g" {} \; || true
            find public -name "*.bak" -delete 2>/dev/null || true
          else
            echo "⚠️ WARNING: API_URL not set. Frontend will not be able to fetch weather data."
            echo "Set API_URL in Amplify Console > App settings > Environment variables"
          fi
        - npm run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths: []
