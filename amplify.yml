version: 1

frontend:
  env:
    variables:
      NODE_ENV: production
      # API_URL: Set this in Amplify Console > App settings > Environment variables
      # Example: https://your-app.us-east-1.elasticbeanstalk.com
      # Leave empty or unset if frontend and backend are on same domain
  phases:
    preBuild:
      commands:
        - echo "PreBuild phase - checking for submodules"
        - |
          if [ -f .gitmodules ]; then
            echo "Found .gitmodules, updating submodules..."
            git submodule update --init --recursive || echo "Submodule update failed, continuing..."
          else
            echo "No .gitmodules found, skipping submodule update"
          fi
    build:
      commands:
        - npm install
        - |
          # Generate api-config.js with API_URL from environment variable
          if [ -n "$API_URL" ]; then
            echo "Generating api-config.js with API_URL: $API_URL"
            echo "// API Configuration - Auto-generated during build" > public/api-config.js
            echo "window.AGROCAST_API_URL = '$API_URL';" >> public/api-config.js
            echo "Generated api-config.js successfully"
          else
            echo "⚠️ WARNING: API_URL environment variable not set!"
            echo "Creating empty api-config.js - backend API will not work"
            echo "// API Configuration - Auto-generated during build" > public/api-config.js
            echo "window.AGROCAST_API_URL = '';" >> public/api-config.js
            echo "Set API_URL in Amplify Console > App settings > Environment variables"
          fi
        - npm run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths: []
