<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroCast ‚Äì Results</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
            overflow-x: hidden;
        }

        .weather-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .rain-drop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.6), rgba(255,255,255,0.2));
            animation: rain-fall linear infinite;
        }
        @keyframes rain-fall {
            to { transform: translateY(100vh); }
        }

        .snowflake {
            position: absolute;
            color: white;
            font-size: 1em;
            animation: snowfall linear infinite;
            opacity: 0.8;
        }
        @keyframes snowfall {
            to { transform: translateY(100vh) rotate(360deg); }
        }

        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.3);
            border-radius: 50px;
            animation: cloud-move linear infinite;
        }
        .cloud:before, .cloud:after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.3);
            border-radius: 50px;
        }
        .cloud:before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }
        .cloud:after {
            width: 60px;
            height: 60px;
            top: -35px;
            right: 10px;
        }
        @keyframes cloud-move {
            to { transform: translateX(100vw); }
        }

        .sun-ray {
            position: absolute;
            width: 2px;
            height: 100px;
            background: linear-gradient(to bottom, rgba(255,255,0,0.4), transparent);
            animation: sun-ray-rotate 10s linear infinite;
            transform-origin: bottom center;
        }
        @keyframes sun-ray-rotate {
            to { transform: rotate(360deg); }
        }

        .bolt {
            position: absolute;
            width: 4px;
            height: 100px;
            background: rgba(255,255,255,0.9);
            animation: lightning-flash 3s infinite;
            opacity: 0;
        }
        @keyframes lightning-flash {
            0%, 90%, 100% { opacity: 0; }
            5%, 10% { opacity: 1; }
        }

        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: 1.25rem;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-top: 100px;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .weather-card, .agri-card {
            border: none;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .weather-header, .agri-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
        }

        .weather-body, .agri-body {
            padding: 24px;
            background: #ffffff;
        }

        .weather-main {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            gap: 20px;
        }

        .weather-icon-wrapper img {
            width: 80px;
            height: 80px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .weather-temp .temperature {
            font-size: 3.5rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .weather-detail-item {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .form-control {
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            padding: 12px 18px;
        }

        .suggestion-item {
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }

        .back-btn:hover {
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px;
                margin: 20px 15px;
                margin-top: 80px;
            }
            .weather-main {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="weather-effects" id="weatherEffects"></div>

    <nav class="navbar fixed-top navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                üåæ AgroCast
            </a>
        </div>
    </nav>

    <div class="container">
        <div id="errorMessage" class="alert alert-danger" role="alert" style="display: none;">
            <strong>‚ö†Ô∏è</strong> <span id="errorText"></span>
        </div>

        <div id="loadingMessage" class="alert alert-info" role="alert">
            Loading weather data...
        </div>

        <div id="weatherContent" style="display: none;">
            <!-- Weather Card -->
            <div class="card weather-card">
                <div class="weather-header">
                    <h4 id="weatherLocation"></h4>
                </div>
                <div class="weather-body">
                    <div class="weather-main">
                        <div class="weather-icon-wrapper">
                            <img id="weatherIcon" src="" alt="Weather icon">
                        </div>
                        <div class="weather-temp">
                            <div class="description" id="weatherDescription"></div>
                            <div class="temperature" id="weatherTemp"></div>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail-item">
                            <div class="label">Feels Like</div>
                            <div class="value" id="feelsLike"></div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="label">Humidity</div>
                            <div class="value" id="humidity"></div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="label">Wind Speed</div>
                            <div class="value" id="windSpeed"></div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="label">Pressure</div>
                            <div class="value" id="pressure"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agriculture Insights Card -->
            <div class="card agri-card">
                <div class="agri-header">
                    <h4>üåæ Smart Agriculture Insights</h4>
                </div>
                <div class="agri-body">
                    <div class="mb-4">
                        <label for="crop" style="font-weight:600; font-size:1rem; margin-bottom:8px; display:block;">Crop Type</label>
                        <select id="crop" class="form-control" style="height:48px; font-size:16px;">
                            <option value="">Select a crop‚Ä¶</option>
                            <option>Rice</option>
                            <option>Wheat</option>
                            <option>Maize</option>
                            <option>Cotton</option>
                            <option>Sugarcane</option>
                            <option>Sorghum (Jowar)</option>
                            <option>Pearl Millet (Bajra)</option>
                            <option>Pigeon Pea (Arhar)</option>
                            <option>Chickpea (Chana)</option>
                            <option>Mustard</option>
                            <option>Groundnut</option>
                            <option>Soybean</option>
                            <option>Barley</option>
                            <option>Tea</option>
                            <option>Coffee</option>
                            <option>Banana</option>
                            <option>Potato</option>
                            <option>Onion</option>
                            <option>Tomato</option>
                        </select>
                    </div>

                    <div id="agri-alerts" class="alert" role="alert" style="display:none; margin-top:12px;"></div>
                    <div id="agri-recommendation" class="mt-3" style="font-weight:600; font-size:1.1rem;"></div>

                    <div id="agri-suggestions" class="row mt-4" style="display:none;">
                        <div class="col-md-6 mb-3">
                            <div class="suggestion-item">
                                <div class="suggestion-label">Irrigation</div>
                                <div class="suggestion-value" id="agri-irrigation"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="suggestion-item">
                                <div class="suggestion-label">Fertilizer</div>
                                <div class="suggestion-value" id="agri-fertilizer"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="suggestion-item">
                                <div class="suggestion-label">Sowing Window</div>
                                <div class="suggestion-value" id="agri-sowing"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="suggestion-item">
                                <div class="suggestion-label">Post-harvest</div>
                                <div class="suggestion-value" id="agri-postharvest"></div>
                            </div>
                        </div>
                        <div class="col-12" id="agri-pest-wrap" style="display:none;">
                            <div class="suggestion-item">
                                <div class="suggestion-label">Pest/Disease Risks</div>
                                <ul id="agri-pestlist" style="margin:8px 0 0 0; padding-left:20px; color:#1e293b; font-weight:500;"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crop Recommendations Card -->
            <div class="card agri-card">
                <div class="agri-header">
                    <h4 id="cropRecoTitle">üìà Recommended Crops</h4>
                </div>
                <div class="agri-body">
                    <div id="avg-stats" class="text-muted mb-3" style="font-size:14px;"></div>
                    <div id="crop-recos" class="row"></div>
                </div>
            </div>
        </div>

        <a href="/" class="back-btn">‚Üê Back to Home</a>
    </div>

    <script>
        // Get city from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const city = urlParams.get('city');

        let weatherData = null;

        // Netlify function base URL
        const API_BASE = '/.netlify/functions';

        // Fetch weather data on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!city) {
                showError('City is required.');
                return;
            }

            document.getElementById('cropRecoTitle').textContent = `üìà Recommended Crops for ${city}`;
            fetchWeatherData(city);
        });

        function fetchWeatherData(city) {
            fetch(`${API_BASE}/weather?city=${encodeURIComponent(city)}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    
                    if (data.ok && data.data) {
                        weatherData = data.data;
                        displayWeatherData(data.data);
                        createWeatherEffects(data.data.weather[0].main.toLowerCase());
                        setupAgricultureFeatures(data.data);
                        fetchCropRecommendations(city);
                    } else {
                        showError(data.error || 'Failed to fetch weather data');
                    }
                })
                .catch(err => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    showError('Failed to fetch weather data: ' + err.message);
                });
        }

        function displayWeatherData(data) {
            document.getElementById('weatherContent').style.display = 'block';
            document.getElementById('weatherLocation').textContent = `${data.name}, ${data.sys.country}`;
            document.getElementById('weatherIcon').src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
            document.getElementById('weatherDescription').textContent = data.weather[0].description;
            document.getElementById('weatherTemp').textContent = Math.round(data.main.temp) + '¬∞C';
            document.getElementById('feelsLike').textContent = Math.round(data.main.feels_like) + '¬∞';
            document.getElementById('humidity').textContent = data.main.humidity + '%';
            document.getElementById('windSpeed').textContent = data.wind.speed + ' m/s';
            document.getElementById('pressure').textContent = data.main.pressure + ' hPa';
        }

        function setupAgricultureFeatures(data) {
            const cropSelect = document.getElementById('crop');
            cropSelect.addEventListener('change', function() {
                const crop = cropSelect.value;
                if (!crop) return;

                const temperature = data.main.temp;
                const humidity = data.main.humidity;
                const rainfall = (data.rain && (data.rain['1h'] || data.rain['3h'])) || 0;

                fetch(`${API_BASE}/agriculture-recommendation?crop=${encodeURIComponent(crop)}&temperature=${temperature}&humidity=${humidity}&rainfall=${rainfall}&city=${encodeURIComponent(city)}`)
                    .then(res => res.json())
                    .then(agriData => {
                        displayAgricultureRecommendation(agriData);
                    })
                    .catch(err => console.error('Error fetching agriculture recommendation:', err));
            });
        }

        function displayAgricultureRecommendation(data) {
            const recEl = document.getElementById('agri-recommendation');
            if (recEl && data.recommendation) {
                const rec = data.recommendation;
                let color = '#0ea5e9';
                const low = rec.toLowerCase();
                if (low.includes('ideal') || low.includes('suitable')) color = '#16a34a';
                if (low.includes('risk') || low.includes('too hot') || low.includes('increase irrigation')) color = '#dc2626';
                recEl.style.color = color;
                recEl.textContent = rec;
            }

            const alertEl = document.getElementById('agri-alerts');
            if (alertEl) {
                const alerts = Array.isArray(data.alerts) ? data.alerts : [];
                if (alerts.length > 0) {
                    alertEl.className = 'alert alert-warning';
                    alertEl.textContent = '‚ö†Ô∏è Alerts: ' + alerts.join(' ‚Ä¢ ');
                    alertEl.style.display = 'block';
                } else {
                    alertEl.style.display = 'none';
                }
            }

            const suggWrap = document.getElementById('agri-suggestions');
            if (suggWrap) suggWrap.style.display = 'block';

            document.getElementById('agri-irrigation').textContent = data.irrigation || '';
            document.getElementById('agri-fertilizer').textContent = data.fertilizer || '';
            document.getElementById('agri-sowing').textContent = data.sowingWindow || '';
            document.getElementById('agri-postharvest').textContent = data.postHarvest || '';

            const pestWrap = document.getElementById('agri-pest-wrap');
            const pestList = document.getElementById('agri-pestlist');
            if (pestWrap && pestList) {
                pestList.innerHTML = '';
                const risks = Array.isArray(data.pestDiseaseRisks) ? data.pestDiseaseRisks : [];
                if (risks.length > 0) {
                    risks.forEach(r => {
                        const li = document.createElement('li');
                        li.textContent = r;
                        pestList.appendChild(li);
                    });
                    pestWrap.style.display = 'block';
                } else {
                    pestWrap.style.display = 'none';
                }
            }
        }

        function fetchCropRecommendations(city) {
            fetch(`${API_BASE}/crop-recommendations?city=${encodeURIComponent(city)}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.recommendedCrops) {
                        const av = data.averages || {};
                        const avgText = [];
                        if (av.avgTemp != null) avgText.push('Avg Temp: ' + av.avgTemp + '¬∞C');
                        if (av.avgHumidity != null) avgText.push('Avg Humidity: ' + av.avgHumidity + '%');
                        if (av.avgRainfall != null) avgText.push('Total Rain (3d): ' + av.avgRainfall + ' mm');
                        document.getElementById('avg-stats').textContent = avgText.join(' ‚Ä¢ ');

                        const cropRecos = document.getElementById('crop-recos');
                        cropRecos.innerHTML = '';
                        if (data.recommendedCrops.length === 0) {
                            cropRecos.innerHTML = '<div class="col-12 text-muted">No strong matches based on average weather. Consider protected cultivation or irrigation planning.</div>';
                            return;
                        }
                        data.recommendedCrops.forEach(name => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 mb-3';
                            col.innerHTML = `<div class="suggestion-item"><div class="suggestion-value">${name}</div></div>`;
                            cropRecos.appendChild(col);
                        });
                    }
                })
                .catch(err => console.error('Error fetching crop recommendations:', err));
        }

        function createWeatherEffects(condition) {
            const effectsContainer = document.getElementById('weatherEffects');
            effectsContainer.innerHTML = '';

            if (condition.includes('rain') || condition.includes('drizzle')) {
                const rain = document.createElement('div');
                rain.className = 'rain';
                for (let i = 0; i < 50; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = Math.random() * 100 + '%';
                    drop.style.animationDelay = Math.random() * 2 + 's';
                    drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    rain.appendChild(drop);
                }
                effectsContainer.appendChild(rain);
            } else if (condition.includes('snow')) {
                const snow = document.createElement('div');
                snow.className = 'snow';
                const symbols = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
                for (let i = 0; i < 50; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snowflake';
                    flake.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    flake.style.left = Math.random() * 100 + '%';
                    flake.style.animationDelay = Math.random() * 5 + 's';
                    flake.style.animationDuration = (Math.random() * 3 + 5) + 's';
                    flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                    snow.appendChild(flake);
                }
                effectsContainer.appendChild(snow);
            } else if (condition.includes('cloud')) {
                const clouds = document.createElement('div');
                clouds.className = 'clouds';
                for (let i = 0; i < 5; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = 'cloud';
                    cloud.style.width = (Math.random() * 100 + 100) + 'px';
                    cloud.style.height = (Math.random() * 40 + 40) + 'px';
                    cloud.style.top = Math.random() * 50 + '%';
                    cloud.style.left = (Math.random() * 20 - 20) + '%';
                    cloud.style.animationDuration = (Math.random() * 20 + 30) + 's';
                    cloud.style.opacity = Math.random() * 0.3 + 0.2;
                    clouds.appendChild(cloud);
                }
                effectsContainer.appendChild(clouds);
            } else if (condition.includes('clear')) {
                const sun = document.createElement('div');
                sun.className = 'sunshine';
                const centerX = window.innerWidth / 2;
                const centerY = 100;
                for (let i = 0; i < 12; i++) {
                    const ray = document.createElement('div');
                    ray.className = 'sun-ray';
                    ray.style.left = centerX + 'px';
                    ray.style.top = centerY + 'px';
                    ray.style.transform = `rotate(${i * 30}deg)`;
                    ray.style.animationDelay = (i * 0.1) + 's';
                    sun.appendChild(ray);
                }
                effectsContainer.appendChild(sun);
            } else if (condition.includes('thunderstorm')) {
                const lightning = document.createElement('div');
                lightning.className = 'lightning';
                for (let i = 0; i < 3; i++) {
                    const bolt = document.createElement('div');
                    bolt.className = 'bolt';
                    bolt.style.left = (Math.random() * 80 + 10) + '%';
                    bolt.style.top = '0%';
                    bolt.style.animationDelay = (i * 1) + 's';
                    lightning.appendChild(bolt);
                }
                effectsContainer.appendChild(lightning);
            }
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>


